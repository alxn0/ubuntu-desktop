#!/bin/bash
# Install SOPS with signature verification

VERSION=3.9.3

# Download and install sops binary
curl -sSLO "https://github.com/getsops/sops/releases/download/v${VERSION}/sops-v${VERSION}.linux.amd64"
sudo mv "sops-v${VERSION}.linux.amd64" "/usr/local/bin/sops"
sudo chmod +x "/usr/local/bin/sops"

# Download verification files
curl -sSLO "https://github.com/getsops/sops/releases/download/v${VERSION}/sops-v${VERSION}.checksums.txt"
curl -sSLO "https://github.com/getsops/sops/releases/download/v${VERSION}/sops-v${VERSION}.checksums.pem"
curl -sSLO "https://github.com/getsops/sops/releases/download/v${VERSION}/sops-v${VERSION}.checksums.sig"

# Verify checksums with cosign
cosign verify-blob "sops-v${VERSION}.checksums.txt" \
  --certificate "sops-v${VERSION}.checksums.pem" \
  --signature "sops-v${VERSION}.checksums.sig" \
  --certificate-identity-regexp=https://github.com/getsops \
  --certificate-oidc-issuer=https://token.actions.githubusercontent.com

# Clean up verification files
rm "sops-v${VERSION}.checksums.txt" "sops-v${VERSION}.checksums.pem" "sops-v${VERSION}.checksums.sig"
